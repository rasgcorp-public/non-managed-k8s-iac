{
    "builders": [
      {
        "type": "googlecompute",
        "project_id": "pocs-sandbox",
        "source_image": "centos-7-v20210721",
        "ssh_username": "centos",
        "zone": "us-east1-b",
        "image_name": "k8s-node-{{isotime | clean_resource_name}}",
        "image_family": "centos-cloud"
      }
    ],
    "provisioners": [
      {
        "type": "shell",
        "inline": [
          "echo 'Install Docker **********************'",
          "sudo yum install -y yum-utils",
          "sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo",
          "sudo yum install -y docker-ce docker-ce-cli containerd.io",          
          "sudo systemctl enable docker",
          "sudo systemctl start docker",
          "sudo usermod -aG docker centos",
          "sudo usermod -aG google-sudoers centos",          
          "echo 'Set up the Docker daemon **********************'",
          "cat <<EOF | sudo tee /etc/docker/daemon.json",
          "{",
          "\"exec-opts\": [\"native.cgroupdriver=systemd\"],",
          "\"log-driver\": \"json-file\",",
          "\"log-opts\": {",
          "    \"max-size\": \"100m\"",
          "  },",
          "\"storage-driver\": \"overlay2\" }",
          "EOF",
          "sudo systemctl restart docker",
          "echo 'Letting iptables see bridged traffic **********************'",
          "cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf",
          "br_netfilter",
          "EOF",
          "cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf",
          "net.bridge.bridge-nf-call-ip6tables = 1",
          "net.bridge.bridge-nf-call-iptables = 1",
          "EOF",
          "sudo sysctl --system",
          "echo 'Open ports **********************'",
          "sudo firewall-cmd --permanent --add-port=6443/tcp",
          "sudo firewall-cmd --permanent --add-port=2379-2380/tcp",
          "sudo firewall-cmd --permanent --add-port=10250/tcp",
          "sudo firewall-cmd --permanent --add-port=10251/tcp",
          "sudo firewall-cmd --permanent --add-port=10252/tcp",
          "sudo firewall-cmd --permanent --add-port=10255/tcp",
          "sudo firewall-cmd --permanent --add-port=8472/udp",
          "sudo firewall-cmd --add-masquerade --permanent",
          "sudo firewall-cmd --permanent --add-port=30000-32767/tcp",
          "sudo systemctl restart firewalld",
          "echo 'Installing kubeadm, kubelet and kubectl **********************'",
          "cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo",
          "[kubernetes]",
          "name=Kubernetes",
          "baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\\$basearch",
          "enabled=1",
          "gpgcheck=1",
          "repo_gpgcheck=1",
          "gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg",
          "exclude=kubelet kubeadm kubectl",
          "EOF",
          "sudo setenforce 0",
          "sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config",
          "sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes",
          "sudo systemctl enable --now kubelet"
        ]
      }
    ]
  }
  